# .github/workflows/auto-index-architecture-docs.yml

name: Auto-Index Architecture Documents

on:
  pull_request:
    types: [closed]
    branches: [main]  # Adjust to your default branch
    paths: 
      - 'docs/**'  # Adjust path to your architecture docs folder
      - 'architecture/**'  # Add other paths as needed

jobs:
  auto-index-docs:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: Install dependencies
      run: |
        npm init -y
        npm install glob
    
    - name: Auto-index architecture documents
      run: |
        node << 'EOF'
        const fs = require('fs');
        const path = require('path');
        const { glob } = require('glob');
        
        // Configuration - adjust these paths for your repository
        const DOCS_DIR = 'docs'; // Change to your architecture docs directory
        const FILE_PATTERNS = ['*.md', '*.adoc', '*.txt']; // Supported file types
        
        async function autoIndexDocuments() {
          console.log('Starting auto-indexing process...');
          
          // Find all architecture documents
          const patterns = FILE_PATTERNS.map(pattern => `${DOCS_DIR}/**/${pattern}`);
          let allFiles = [];
          
          for (const pattern of patterns) {
            const files = await glob(pattern);
            allFiles = allFiles.concat(files);
          }
          
          // Filter out files that already have index numbers (0001-9999)
          const indexedFiles = allFiles.filter(file => {
            const basename = path.basename(file);
            return /^\d{4}-/.test(basename);
          });
          
          const unindexedFiles = allFiles.filter(file => {
            const basename = path.basename(file);
            return !/^\d{4}-/.test(basename);
          });
          
          if (unindexedFiles.length === 0) {
            console.log('No unindexed files found. Nothing to do.');
            return;
          }
          
          // Find the highest existing index
          let maxIndex = 0;
          indexedFiles.forEach(file => {
            const basename = path.basename(file);
            const match = basename.match(/^(\d{4})-/);
            if (match) {
              const index = parseInt(match[1], 10);
              if (index > maxIndex) {
                maxIndex = index;
              }
            }
          });
          
          console.log(`Found ${indexedFiles.length} indexed files, highest index: ${maxIndex.toString().padStart(4, '0')}`);
          console.log(`Found ${unindexedFiles.length} unindexed files to process`);
          
          // Sort unindexed files for consistent ordering
          unindexedFiles.sort();
          
          // Rename unindexed files with sequential numbering
          const renames = [];
          unindexedFiles.forEach((file, i) => {
            const newIndex = (maxIndex + i + 1).toString().padStart(4, '0');
            const dir = path.dirname(file);
            const basename = path.basename(file);
            const newFilename = `${newIndex}-${basename}`;
            const newPath = path.join(dir, newFilename);
            
            renames.push({ from: file, to: newPath, index: newIndex });
          });
          
          // Perform the renames
          let renamed = [];
          for (const rename of renames) {
            try {
              fs.renameSync(rename.from, rename.to);
              renamed.push(rename);
            } catch (error) {
              console.error(`Failed to rename ${rename.from}:`, error.message);
            }
          }
        }
        
        autoIndexDocuments().catch(console.error);
        EOF
    
    - name: Check for changes
      id: check_changes
      run: |
        if git diff --quiet; then
          echo "has_changes=false" >> $GITHUB_OUTPUT
        else
          echo "has_changes=true" >> $GITHUB_OUTPUT
        fi
    
    - name: Commit and push changes
      if: steps.check_changes.outputs.has_changes == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Only add the docs directory and exclude npm/node files
        git add docs/
        # Add any other architecture directories if you have them
        # git add architecture/
        
        # Make sure we don't accidentally commit npm files
        git reset HEAD package*.json node_modules/ 2>/dev/null || true
        
        git commit -m "Auto-index architecture documents"
        git push
